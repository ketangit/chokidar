<!doctype html>
<html lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Chokidar</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
        .tg {
            border-collapse: collapse;
            border-spacing: 0;
        }
        .tg td {
            font-family: Verdana, Geneva, sans-serif !important;
            font-size: 14px;
            font-weight: normal;
            padding: 0px 2px;
            border-style: solid;
            border-width: 1px;
            overflow: hidden;
            word-break: normal;
        }
        .tg .no-border {
           font-family: Verdana, Geneva, sans-serif !important;
           font-size: 14px;
           font-weight: normal;
           padding: 0px 2px;
           border-width: 0px;
           overflow: hidden;
           word-break: normal;
        }
    </style>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap-theme.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Chokidar</a>
            </div>
        </div>
    </nav>
    <!--
        <div class="jumbotron">
            <div class="container">
                <form>
                    <h3>Port values test</h3>
                    <div class="form-group">
                        <input id="portValueText" type="text" placeholder="Port String" class="form-control">
                    </div>
                    <p><input type="button" id="portButton" value="Check Ports" class="btn btn-success" /></p>
                </form>
                <div id="portContent"></div>
            </div>
        </div>
    -->
    <div class="container">
        <p>&nbsp;</p>
        <table class="tg">
            <tr>
                <td class="no-border">Garage Door</td>
                <td>1</td>
            </tr>
            <tr><td class="no-border" colspan="2"></td></tr>
            <tr>
                <td class="no-border">Front Door</td>
                <td>1</td>
            </tr>
            <tr><td class="no-border" colspan="2"></td></tr>
            <tr>
                <td class="no-border">Back Door</td>
                <td>1</td>
            </tr>
            <tr><td class="no-border" colspan="2"></td></tr>
            <tr>
                <td class="no-border">Sliding Door</td>
                <td>1</td>
            </tr>
            <tr><td class="no-border" colspan="2">&nbsp;</td></tr>
            <tr>
                <td class="no-border">Breakfast Room Windows&nbsp;</td>
                <td>1</td>
                <td>2</td>
                <td>3</td>
                <td>4</td>
                <td>5</td>
                <td>6</td>
                <td>7</td>
            </tr>
            <tr><td class="no-border" colspan="8"></td></tr>
            <tr>
                <td class="no-border">Family Room Windows</td>
                <td>1</td>
                <td>2</td>
            </tr>
            <tr><td class="no-border" colspan="3"></td></tr>
            <tr>
                <td class="no-border">Study Room Windows</td>
                <td>1</td>
                <td>2</td>
                <td>3</td>
                <td>4</td>
            </tr>
            <tr><td class="no-border" colspan="5"></td></tr>
            <tr>
                <td class="no-border">Senior Room Windows</td>
                <td>1</td>
                <td>2</td>
            </tr>
            <tr><td class="no-border" colspan="3"></td></tr>
            <tr>
                <td class="no-border">Dinning Room Windows</td>
                <td>1</td>
                <td>2</td>
            </tr>
            <tr><td class="no-border" colspan="3"></td></tr>
            <tr>
                <td class="no-border">Living Room Windows</td>
                <td>1</td>
                <td>2</td>
            </tr>
            <tr><td class="no-border" colspan="2">&nbsp;</td></tr>
            <tr>
                <td class="no-border">Foyer Motion</td>
                <td>1</td>
            </tr>
        </table>
        <hr>
    </div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script>
        var portConfig = {
            "C1": {
                "0": ["Breakfast Room Window - 1", "8", "1"],
                "1": ["Breakfast Room Window - 2", "8", "2"],
                "2": ["Breakfast Room Window - 3", "8", "3"],
                "3": ["Breakfast Room Window - 4", "8", "4"],
                "4": ["Breakfast Room Window - 5", "8", "5"],
                "5": ["Breakfast Room Window - 6", "8", "6"],
                "6": ["Breakfast Room Window - 7", "8", "7"],
                "7": ["Foyer Motion", "20", "1"]
            },
            "C2": {
                "0": ["Family Room Window - 1", "10", "1"],
                "1": ["Family Room Window - 2", "10", "2"],
                "2": ["Study Room Window - 1", "12", "1"],
                "3": ["Study Room Window - 2", "12", "2"],
                "4": ["Study Room Window - 3", "12", "3"],
                "5": ["Study Room Window - 4", "12", "4"],
                "6": ["Senior Room Window - 1", "14", "1"],
                "7": ["Senior Room Window - 2", "14", "2"]
            },
            "C3": {
                "0": ["Dinning Room Window - 1", "16", "1"],
                "1": ["Dinning Room Window - 2", "16", "2"],
                "2": ["Living Room Window - 1", "18", "1"],
                "3": ["Living Room Window - 2", "18", "2"],
                "4": ["Front Door", "2", "1"],
                "5": ["Garage Door", "0", "1"],
                "6": ["Sliding Door", "6", "1"],
                "7": ["Back Door", "4", "1"]
            }
        };

        var socketaddy = "ws://raspberrypi:1880/ws/ports";
        var sock;
        $(document).ready(function () {
            sock = new WebSocket(socketaddy);
            sock.onopen = function () {
                console.log("Connected websocket");
                console.log("Sending ping..");
                sock.send("Ping!");
                console.log("Ping sent..");
            };
            sock.onerror = function () {
                console.log("Websocket error");
            };
            sock.onmessage = function (event) {
                var sensorString = event.data;
                console.log(sensorString);
                clearPorts();
                processPortValues(sensorString);
            }
        });

        $("#portButton").on("click", function (e) {
            var sensorString = $("#portValueText").val();
            if (sensorString.trim()) {
                clearPorts();
                processPortValues(sensorString);
            }
        });

        function processPortValues(sensorPortString) {
            if (sensorPortString.trim()) {
                var portArray = sensorPortString.split(" ");
                if (portArray != null && portArray.length > 0) {
                    for (var i = 0; i < portArray.length; i++) {
                        var portString = portArray[i];
                        //$("#portContent").append(portString + "<br/>");
                        if (portString != null) {
                            var pvArray = portString.split("=");
                            if (pvArray != null && pvArray.length > 2) {
                                var portName = pvArray[0];
                                if (pvArray.length == 3) {
                                    var activePins = pvArray[2];
                                    if (activePins != null) {
                                        var pinArray = activePins.split("-");
                                        if (pinArray != null && pinArray.length > 0) {
                                            var portNameArray = portConfig[portName];
                                            for (var p = 0; p < pinArray.length; p++) {
                                                var pin = pinArray[p];
                                                if (portNameArray[pin][1] >= 0 && portNameArray[pin][2] > 0) {
                                                    //$("#portContent").append(portName + "-" + pin + " -> " + portNameArray[pin][0] + "<br/>");
                                                    $('table tr').eq(portNameArray[pin][1]).find('td').eq(portNameArray[pin][2]).css('background-color', 'red');
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        function clearPorts() {
            //$("#portContent").empty();
            var allPorts = Object.keys(portConfig);
            for (var i = 0; i < allPorts.length; i++) {
                var port = portConfig[allPorts[i]];
                for (var p = 0; p < 8; p++) {
                    if (port[p][1] >= 0 && port[p][2] > 0) {
                        $('table tr').eq(port[p][1]).find('td').eq(port[p][2]).css('background-color', 'green');
                    }
                }
            }
        }
    </script>

</body>
</html>
